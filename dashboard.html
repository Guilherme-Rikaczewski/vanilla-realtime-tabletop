<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <h2>Minha Conta</h2>
  <span id="room"></span>
  <input id="username" style="width: 280px;">
  <input id="email" style="width: 280px;">
  <input id="password" placeholder="Nova senha" style="width: 280px;">

  <button onclick="update()">Salvar</button>
  <button onclick="logout()">Logout</button>
  <button onclick="create_room()">ENTRAR EM SALA</button>
</div>

<script>
const domain = 'localhost'
async function getCSRFToken() {
  const res = await fetch(`http://${domain}:8000/users/csrf/`, {
    credentials: "include"
  });

  const data = await res.json();
  return data.csrfToken;
}
async function loadUser() {
  const res = await fetch(`http://${domain}:8000/users/`, {
    credentials: "include"
  });

  if (!res.ok) {
    window.location.href = "index.html";
    return;
  }

  const data = await res.json();
  username.value = data.username;
  email.value = data.email;
  document.getElementById('room').innerHTML = 'Sua sala: '+data.room[0]
}


async function update() {
  const csrf = await getCSRFToken();

  const payload = {
    username: username.value,
    email: email.value
  };

  if (password.value) {
    payload.password = password.value;
  }

  const res = await fetch(`http://${domain}:8000/users/update/`, {
    method: "PATCH",
    credentials: "include",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrf
    },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    alert("Dados atualizados");
  }
  // const socket = new WebSocket(`ws://${domain}:8000/ws/secure/`);

}

async function logout() {
  const csrf = await getCSRFToken();

  await fetch(`http://${domain}:8000/users/logout/`, {
    method: "POST",
    credentials: "include",
    headers: { "X-CSRFToken": csrf }
  });

  window.location.href = "index.html";
}


async function create_room(params) {
  window.location.href = "room.html"
}

loadUser();
</script>
</body>
</html>
