<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Board Sync</title>

<style>
body {
  background:#1e1e1e;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
  gap:10px;
}

.controls {
  display:flex;
  gap:10px;
  align-items:center;
  color:#fff;
  font-family:sans-serif;
}

button, input[type="button"] {
  padding:8px 16px;
  background:#444;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

button:hover, input[type="button"]:hover {
  background:#666;
}

.board {
  position:relative;
  width:400px;
  height:400px;
  background:#2a2a2a;
  border:2px solid #555;
}

.grid {
  position:absolute;
  inset:0;
  display:grid;
  grid-template-columns:repeat(8,1fr);
  grid-template-rows:repeat(8,1fr);
  pointer-events:none;
}

.grid div { border:1px solid #333; }
.no-grid div { border:none; }

.piece {
  position:absolute;
  width:50px;
  height:50px;
  border-radius:6px;
  cursor:grab;
  z-index:5;

  display:flex;
  align-items:center;
  justify-content:center;
}

.piece span {
  color:#fff;
  font-size:10px;
  font-family:sans-serif;
  font-weight:bold;
  text-align:center;
  pointer-events:none;
  user-select:none;
  text-shadow:0 0 3px rgba(0,0,0,.8);
}
</style>
</head>

<body>

<div class="controls">
  <input type="text" id="room" placeholder="Sala">
  <input type="button" value="Entrar" onclick="enterRoom()">

  <button id="toggleGrid">Desativar grid</button>

  <label>
    <input type="checkbox" id="precisionMode">
    Modo super precis√£o
  </label>
</div>

<div class="board" id="board">
  <div class="grid" id="grid">
    <script>
      for (let i = 0; i < 64; i++) document.write("<div></div>");
    </script>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const domain = "localhost";
const GRID_SIZE = 50;

/* ================= STATE ================= */
let socket = null;
let myUser = null;
let myColor = null;

let snapToGrid = true;
let precisionMode = false;

let dragging = false;
let currentPiece = null;

const pieces = {};

/* ================= ELEMENTS ================= */
const board = document.getElementById("board");
const grid = document.getElementById("grid");
const toggleBtn = document.getElementById("toggleGrid");
const precisionCheckbox = document.getElementById("precisionMode");

/* ================= HELPERS ================= */
const snap = v => Math.floor(v / GRID_SIZE) * GRID_SIZE;

/* ================= Z-INDEX ================= */
function promoteMyPiece() {
  Object.entries(pieces).forEach(([user, piece]) => {
    piece.style.zIndex = (user === myUser) ? 10 : 5;
  });
}

/* ================= PIECES ================= */
function createPiece(user, color, x = 0, y = 0) {
  if (!user || pieces[user]) return;

  const piece = document.createElement("div");
  piece.className = "piece";
  piece.id = `piece-${user}`;
  piece.style.background = color;
  piece.style.left = x + "px";
  piece.style.top  = y + "px";

  const label = document.createElement("span");
  label.textContent = user;
  piece.appendChild(label);

  board.appendChild(piece);
  pieces[user] = piece;

  piece.addEventListener("mousedown", () => {
    if (user !== myUser) return;
    dragging = true;
    currentPiece = piece;
    piece.style.zIndex = 20;
  });
}

/* ================= SOCKET ================= */
function enterRoom() {
  const room = document.getElementById("room").value;
  socket = new WebSocket(`ws://${domain}:8000/ws/secure/?room=${room}`);

  socket.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    const user = msg.user;
    const data = msg.data;
    if (!data?.type) return;

    switch (data.type) {

      case "user_joined":
        createPiece(user, data.color);

        if (!myUser) {
          myUser = user;
          myColor = data.color;
          promoteMyPiece();
        } else {
          const myPiece = pieces[myUser];
          socket.send(JSON.stringify({
            type: "state_sync",
            x: myPiece.offsetLeft,
            y: myPiece.offsetTop,
            color: myColor
          }));
        }
        break;

      case "state_sync":
        createPiece(user, data.color, data.x, data.y);
        promoteMyPiece();
        break;

      case "user_left":
        if (pieces[user]) {
          pieces[user].remove();
          delete pieces[user];
        }
        break;

      case "movement": {
        const piece = pieces[user];
        if (!piece || (dragging && user === myUser)) return;
        piece.style.left = data.x + "px";
        piece.style.top  = data.y + "px";
        break;
      }

      case "grid-click":
        snapToGrid = data.enabled;
        grid.classList.toggle("no-grid", !snapToGrid);
        toggleBtn.textContent = snapToGrid
          ? "Desativar grid"
          : "Ativar grid";
        break;

      case "precision-toggle":
        precisionMode = data.enabled;
        precisionCheckbox.checked = precisionMode;
        break;
    }
  };
}

/* ================= GRID ================= */
toggleBtn.onclick = () => {
  socket.send(JSON.stringify({
    type: "grid-click",
    enabled: !snapToGrid
  }));
};

precisionCheckbox.onchange = () => {
  socket.send(JSON.stringify({
    type: "precision-toggle",
    enabled: precisionCheckbox.checked
  }));
};

/* ================= DRAG ================= */
document.addEventListener("mousemove", e => {
  if (!dragging || !currentPiece) return;

  const rect = board.getBoundingClientRect();
  let x = e.clientX - rect.left - 25;
  let y = e.clientY - rect.top  - 25;

  currentPiece.style.left = x + "px";
  currentPiece.style.top  = y + "px";

  if (precisionMode) {
    socket.send(JSON.stringify({ type: "movement", x, y }));
  }
});

document.addEventListener("mouseup", () => {
  if (!dragging || !currentPiece) return;

  let x = currentPiece.offsetLeft;
  let y = currentPiece.offsetTop;

  if (snapToGrid) {
    x = snap(x);
    y = snap(y);
  }

  currentPiece.style.left = x + "px";
  currentPiece.style.top  = y + "px";
  promoteMyPiece();

  socket.send(JSON.stringify({ type: "movement", x, y }));

  dragging = false;
  currentPiece = null;
});
</script>

</body>
</html>
